{% extends 'dev_productivity/base.html' %}
{% block title %}FDS Dashboard{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Developer Productivity Dashboard</h3>
  <a href="{% url 'analysis_detail' analysis.id %}" class="btn btn-outline-secondary">Back to Analysis</a>
  </div>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Total Commits</div>
        <div id="kpi-commits" class="fs-3 fw-bold">—</div>
        <div id="kpi-dataset" class="text-truncate small"></div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Total Builds</div>
        <div id="kpi-builds" class="fs-3 fw-bold">—</div>
        <div class="small text-muted">TORQUE clusters</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Avg Commits/Build</div>
        <div id="kpi-avg" class="fs-3 fw-bold">—</div>
        <div class="small text-muted">Clustering efficiency</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Developers</div>
        <div id="kpi-devs" class="fs-3 fw-bold">—</div>
        <div class="small text-muted">Distinct authors</div>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-pills mb-3" id="dashboardTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="overview-tab" data-bs-toggle="pill" data-bs-target="#overview" type="button" role="tab">Overview</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="fds-tab" data-bs-toggle="pill" data-bs-target="#fds" type="button" role="tab">Fair Developer Score</button>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade show active" id="overview" role="tabpanel">
    <div class="row g-3">
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Build Activity Trend</div>
          <div class="card-body"><canvas id="chartActivity" height="200"></canvas></div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Code Quality Trend</div>
          <div class="card-body"><canvas id="chartQuality" height="200"></canvas></div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Developers per Build (avg)</div>
          <div class="card-body"><canvas id="chartDevs" height="200"></canvas></div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Churn per Build Segment</div>
          <div class="card-body"><canvas id="chartChurn" height="200"></canvas></div>
        </div>
      </div>
      <div class="col-12">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Top 10 Builds by Importance</div>
          <div class="card-body"><canvas id="chartTopBuilds" height="120"></canvas></div>
        </div>
      </div>

      <!-- New: Developer-centric charts -->
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Top Developers by FDS</div>
          <div class="card-body"><canvas id="chartTopDevFDS" height="200"></canvas></div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Top Developers by Commits</div>
          <div class="card-body"><canvas id="chartTopDevCommits" height="200"></canvas></div>
        </div>
      </div>
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Top Developers by Churn</div>
          <div class="card-body"><canvas id="chartTopDevChurn" height="200"></canvas></div>
        </div>
      </div>

      <!-- New: Clustering parameters & results -->
      <div class="col-xl-6">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white fw-semibold">Torque Clustering Parameters & Results</div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="small text-muted">Alpha (α)</div>
                <div id="param-alpha" class="fw-semibold">—</div>
                <div class="small text-muted">Time weight coefficient</div>
              </div>
              <div class="col-6">
                <div class="small text-muted">Beta (β)</div>
                <div id="param-beta" class="fw-semibold">—</div>
                <div class="small text-muted">LOC weight coefficient</div>
              </div>
              <div class="col-6">
                <div class="small text-muted">Gap Threshold</div>
                <div id="param-gap" class="fw-semibold">—</div>
                <div class="small text-muted">Torque threshold</div>
              </div>
              <div class="col-6">
                <div class="small text-muted">Batch Reduction</div>
                <div id="kpi-reduction" class="fw-semibold">—</div>
                <div class="small text-muted">commits → builds</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- New: FDS dimensions and formula -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-header bg-white fw-semibold">FDS Assessment Dimensions</div>
          <div class="card-body">
            <p class="text-muted mb-3">The Fair Developer Score (FDS) evaluates developer contributions across six key dimensions. Each dimension is standardized (MAD-Z) and combined with weights to form the final score.</p>
            <div class="row g-3">
              <div class="col-md-4">
                <div class="p-3 border rounded h-100">
                  <div class="fw-semibold">Scale (25%)</div>
                  <div class="small text-muted">Code volume: log(1 + author churn)</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded h-100">
                  <div class="fw-semibold">Reach (15%)</div>
                  <div class="small text-muted">Directory entropy & impact scope</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded h-100">
                  <div class="fw-semibold">Centrality (20%)</div>
                  <div class="small text-muted">Core module involvement (PageRank)</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded h-100">
                  <div class="fw-semibold">Dominance (20%)</div>
                  <div class="small text-muted">Batch leadership & ownership</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded h-100">
                  <div class="fw-semibold">Novelty (15%)</div>
                  <div class="small text-muted">New files & key paths</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="p-3 border rounded h-100">
                  <div class="fw-semibold">Speed (5%)</div>
                  <div class="small text-muted">Commit frequency & timing</div>
                </div>
              </div>
            </div>
            <div class="mt-3 small text-muted">FDS = 0.25×Scale + 0.15×Reach + 0.20×Centrality + 0.20×Dominance + 0.15×Novelty + 0.05×Speed</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-pane fade" id="fds" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-semibold">Developers</div>
      <select id="devCount" class="form-select form-select-sm" style="width: 220px">
        <option value="1000" selected>All Developers</option>
        <option value="5">Top 5 Developers</option>
        <option value="10">Top 10 Developers</option>
        <option value="15">Top 15 Developers</option>
        <option value="20">Top 20 Developers</option>
      </select>
    </div>

    <div id="devGrid" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3"></div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function fetchDashboardData() {
  const url = `{% url 'dashboard_data' analysis.id %}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('Failed to load dashboard data');
  return await res.json();
}

function el(id){ return document.getElementById(id); }

function setKPIs(summary, developers){
  el('kpi-commits').textContent = summary.totalCommits ?? 0;
  el('kpi-builds').textContent = summary.totalBatches ?? 0;
  el('kpi-avg').textContent = (summary.avgCommitsPerBatch ?? 0).toFixed(2);
  el('kpi-devs').textContent = developers.length;
  el('kpi-dataset').textContent = summary.dataset || '';
}

let charts = { activity: null, quality: null, devs: null, churn: null, topBuilds: null };

function ensureChart(ctx, type, data, options){
  if (charts[ctx.canvas.id]) charts[ctx.canvas.id].destroy();
  charts[ctx.canvas.id] = new Chart(ctx, { type, data, options });
}

function renderOverviewCharts(chartsData){
  const labels = chartsData.months?.length ? chartsData.months : ['Segment 1','Segment 2','Segment 3','Segment 4'];
  const batchCounts = chartsData.batchCounts?.length ? chartsData.batchCounts : [0,0,0,0];
  const qualityScores = chartsData.qualityScores?.length ? chartsData.qualityScores : [70,75,80,85];
  const devCounts = chartsData.devCounts?.length ? chartsData.devCounts : [1,1,1,1];
  const churn = chartsData.churnPerChunk?.length ? chartsData.churnPerChunk : [0,0,0,0];

  ensureChart(
    el('chartActivity').getContext('2d'),
    'line',
    { labels, datasets:[{label:'Builds', data: batchCounts, borderColor:'#6f42c1', backgroundColor:'rgba(111,66,193,0.1)', tension:0.3, fill:true }] },
    { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  );

  ensureChart(
    el('chartQuality').getContext('2d'),
    'line',
    { labels, datasets:[{label:'Quality', data: qualityScores, borderColor:'#198754', backgroundColor:'rgba(25,135,84,0.1)', tension:0.3, fill:true }] },
    { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, max:100 } } }
  );

  ensureChart(
    el('chartDevs').getContext('2d'),
    'bar',
    { labels, datasets:[{label:'Developers per Build', data: devCounts, backgroundColor:'rgba(99,102,241,0.6)'}] },
    { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, suggestedMax: Math.max(2, Math.ceil(Math.max(...devCounts, 1))) } } }
  );

  ensureChart(
    el('chartChurn').getContext('2d'),
    'bar',
    { labels, datasets:[{label:'Churn', data: churn, backgroundColor:'rgba(249,115,22,0.6)'}] },
    { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  );
}

function devCard(dev){
  const dims = [
    ['scale', dev.scale, 25],
    ['reach', dev.reach, 15],
    ['centrality', dev.centrality, 20],
    ['dominance', dev.dominance, 20],
    ['novelty', dev.novelty, 15],
    ['speed', dev.speed, 5],
  ];
  return `
  <div class="col">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
          <div class="d-flex align-items-center gap-2">
            <div class="rounded-circle d-flex align-items-center justify-content-center text-white" style="width:48px;height:48px;background:linear-gradient(135deg,#667eea,#764ba2)">${dev.avatar || 'DV'}</div>
            <div>
              <div class="fw-semibold">${dev.name}</div>
              <div class="text-muted small">${dev.role || ''}</div>
            </div>
          </div>
          <div class="text-end">
            <div class="fs-4 fw-bold" style="color:#6f42c1">${dev.overall}</div>
            <div class="small text-muted">FDS Score</div>
          </div>
        </div>
        <div class="row text-center mt-3">
          <div class="col-4"><div class="fw-semibold">${dev.batches}</div><div class="text-muted small">Builds</div></div>
          <div class="col-4"><div class="fw-semibold">${dev.avgTBS}</div><div class="text-muted small">Avg TBS</div></div>
          <div class="col-4"><div class="fw-semibold">${dev.qualityScore}</div><div class="text-muted small">Quality</div></div>
        </div>
        <div class="mt-3">
          ${dims.map(([n,val,w])=>`
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="text-capitalize small text-muted">${n} (${w}%)</span>
              <div class="d-flex align-items-center gap-2">
                <div class="progress" style="width:120px;height:6px;">
                  <div class="progress-bar" role="progressbar" style="width:${val}%" aria-valuenow="${val}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <span class="small fw-semibold">${val}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  </div>`;
}

function renderDevelopers(allDevelopers){
  const max = parseInt(el('devCount').value, 10) || 1000;
  const sorted = [...allDevelopers].sort((a,b)=>b.overall - a.overall);
  el('devGrid').innerHTML = sorted.slice(0, max).map(devCard).join('');
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const data = await fetchDashboardData();
    setKPIs(data.summary, data.developers || []);
    renderOverviewCharts(data.charts || {});
    // Top builds chart
    if (data.topBuilds) {
      const ctx = el('chartTopBuilds')?.getContext('2d');
      if (ctx) {
        ensureChart(
          ctx,
          'bar',
          { labels: data.topBuilds.labels, datasets:[
            { label:'Importance (%)', data: data.topBuilds.importance, backgroundColor:'rgba(34,197,94,0.7)' },
            { label:'Commits', data: data.topBuilds.commits, backgroundColor:'rgba(59,130,246,0.5)' }
          ]},
          { responsive:true, scales:{ y:{ beginAtZero:true } } }
        );
      }
    }
    renderDevelopers(data.developers || []);
    el('devCount').addEventListener('change', ()=>renderDevelopers(data.developers || []));

    // Developer-centric charts (Top 10)
    const topByFDS = [...(data.developers||[])].sort((a,b)=>b.overall-a.overall).slice(0,10);
    const topByCommits = [...(data.developers||[])].sort((a,b)=>b.commitCount-a.commitCount).slice(0,10);
    const topByChurn = [...(data.developers||[])].sort((a,b)=>b.totalChurn-a.totalChurn).slice(0,10);
    const labelsDev = topByFDS.map(d=>d.name || d.email);
    const ctxFDS = el('chartTopDevFDS')?.getContext('2d');
    if (ctxFDS && topByFDS.length) ensureChart(ctxFDS,'bar',{labels:labelsDev,datasets:[{label:'FDS',data:topByFDS.map(d=>d.overall),backgroundColor:'rgba(111,66,193,0.7)'}]},{responsive:true,scales:{y:{beginAtZero:true}}});
    const ctxCmt = el('chartTopDevCommits')?.getContext('2d');
    if (ctxCmt && topByCommits.length) ensureChart(ctxCmt,'bar',{labels:topByCommits.map(d=>d.name||d.email),datasets:[{label:'Commits',data:topByCommits.map(d=>d.commitCount),backgroundColor:'rgba(59,130,246,0.7)'}]},{responsive:true,scales:{y:{beginAtZero:true}}});
    const ctxChn = el('chartTopDevChurn')?.getContext('2d');
    if (ctxChn && topByChurn.length) ensureChart(ctxChn,'bar',{labels:topByChurn.map(d=>d.name||d.email),datasets:[{label:'Churn',data:topByChurn.map(d=>d.totalChurn),backgroundColor:'rgba(234,88,12,0.7)'}]},{responsive:true,scales:{y:{beginAtZero:true}}});

    // Clustering params and reduction
    document.getElementById('param-alpha').textContent = data.clustering?.alpha ?? '—';
    document.getElementById('param-beta').textContent = data.clustering?.beta ?? '—';
    document.getElementById('param-gap').textContent = data.clustering?.gap ?? '—';
    const commits = data.summary?.totalCommits || 0;
    const builds = data.summary?.totalBatches || 0;
    const reduction = commits ? (((commits-builds)/commits)*100).toFixed(1) : '0.0';
    document.getElementById('kpi-reduction').textContent = `${reduction}%`;
  } catch (e) {
    console.error('Dashboard init error', e);
  }
});
</script>
{% endblock %}


